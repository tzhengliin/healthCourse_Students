<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>高雄博士班-健管學員清單</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* 頂部留白；左右 0 */
      body {
        margin: 0;
        padding: 12px 0 0 0;
        padding-top: max(12px, env(safe-area-inset-top));
      }

      .table-fixed-header thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
      }

      /* ===== 進度地圖容器 ===== */
      .board-wrap {
        width: 100%;
      }
      .board-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }

      /* 每行：左側週標籤 + 右側 7 格（右側用 flex，讓同一 row 自動等高） */
      .board-row {
        display: grid;
        grid-template-columns: 40px 1fr; /* 週標籤 + 天數區 */
        gap: 8px;
        width: 100%;
      }
      .days-row {
        display: flex;
        gap: 8px;
        width: 100%;
        align-items: stretch;
      }

      /* 垂直週數標籤（用 c1~c7 套色） */
      .week-tag {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        color: #fff;
        font-weight: 800;
        letter-spacing: 0.05em;
        border: 1px solid rgba(0, 0, 0, 0.06);
        padding: 4px 0;
        user-select: none;
      }

      /* 天數方格：高度由內容自然撐開（僅在整週全空時以 JS 設定固定高度） */
      .board-cell {
        position: relative;
        border-radius: 12px;
        border: 1px solid #d5e8d5;
        background: #edf7ee;
        flex: 1 1 0;
        padding-top: 26px; /* 預留上方給 day-label */
        overflow: visible;
      }
      .day-label {
        position: absolute;
        top: 4px;
        left: 6px;
        font-weight: 800;
        font-size: 0.9rem;
        color: #164e22;
        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
        pointer-events: none;
      }

      /* 姓名容器：走正常文流（參與高度計算） */
      .names-full {
        position: static;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        gap: 4px;
      }
      .name-row {
        width: 100%;
        text-align: center;
        font-weight: 800;
        line-height: 1.2;
        color: #0f5132;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        padding: 3px 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 18px; /* ★ 電腦版固定 18px（手機會覆寫） */
      }
      /* ===== 手機（<=576px）規則 ===== */
      @media (max-width: 576px) {
        /* 手機板：每格至少 100px 高 */
        .board-cell {
          flex: 2 1 0; /* 你的原設定 */
          min-height: 100px; /* ★ 新增：最小高度 100px */
        }
        .board-cell.col-wide {
          flex: 3 1 0;
        }
        .board-cell.col-narrow {
          flex: 1 1 0;
        }

        /* 手機板：姓名最小 12px（取代原本 10px） */
        .name-row {
          font-size: 12px !important; /* ★ 新增：最小字級 12px */
          padding: 2px 4px;
        }

        .day-label {
          font-size: 0.8rem;
        }
      }

      /* 若你先前已加過桌機最小 150px，這段可保留；若尚未加，建議一起加入 */
      @media (min-width: 577px) {
        .board-cell {
          min-height: 150px;
        } /* 桌機最小 150px */
      }

      /* ===== 下方表格 ===== */
      .badge-status {
        font-weight: 700;
        font-size: 1rem;
        padding: 0.5em 0.65em;
        line-height: 1;
      } /* 放大一點 */
      .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid var(--bs-border-color, #dee2e6);
        vertical-align: middle;
      }
      .badge-menu {
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.45em 0.6em;
        line-height: 1;
      }
      .table-center thead th,
      .table-center tbody td {
        text-align: center;
        vertical-align: middle;
      }

      .week-grid {
        display: inline-flex;
        gap: 0.3rem;
        justify-content: center;
        align-items: center;
      }
      .week-box {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 800;
        font-size: 0.9rem;
        user-select: none;
        border: 1px solid var(--bs-border-color, #dee2e6);
      }
      .week-box.inactive {
        background: var(--bs-light);
        color: var(--bs-secondary);
      }

      /* 週色（表格與週標籤共用） */
      .c1 {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
        box-shadow: 0 0 0 0.12rem rgba(239, 68, 68, 0.15);
      }
      .c2 {
        background: #f59e0b;
        color: #111;
        border-color: #f59e0b;
        box-shadow: 0 0 0 0.12rem rgba(245, 158, 11, 0.15);
      }
      .c3 {
        background: #facc15;
        color: #111;
        border-color: #facc15;
        box-shadow: 0 0 0 0.12rem rgba(250, 204, 21, 0.2);
      }
      .c4 {
        background: #22c55e;
        color: #fff;
        border-color: #22c55e;
        box-shadow: 0 0 0 0.12rem rgba(34, 197, 94, 0.18);
      }
      .c5 {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.12rem rgba(59, 130, 246, 0.18);
      }
      .c6 {
        background: #6366f1;
        color: #fff;
        border-color: #6366f1;
        box-shadow: 0 0 0 0.12rem rgba(99, 102, 241, 0.18);
      }
      .c7 {
        background: #a855f7;
        color: #fff;
        border-color: #a855f7;
        box-shadow: 0 0 0 0.12rem rgba(168, 85, 247, 0.18);
      }
    </style>
  </head>
  <body>
    <div class="container-fluid px-0">
      <!-- ===== 進度地圖區塊 ===== -->
      <div class="board-wrap px-3 mb-3">
        <h2 class="h5 mb-2">進度地圖</h2>
        <div id="boardGrid" class="board-grid" aria-label="健管 45 天（每週左到右）"></div>
      </div>

      <h1 class="h3 mb-3 px-3">高雄博士班-健管45學員清單</h1>

      <!-- 篩選 + 重新讀取 -->
      <div class="row g-2 align-items-center mb-3 px-3">
        <div class="col-auto"><label for="filterInput" class="col-form-label">關鍵字篩選：</label></div>
        <div class="col-12 col-sm-6 col-md-4"><input type="text" id="filterInput" class="form-control" placeholder="輸入姓名 / 教練 / 狀態 / 菜單 …" /></div>
        <div class="col-auto"><button id="reloadBtn" class="btn btn-outline-primary">重新讀取</button></div>
      </div>

      <!-- 載入中 / 錯誤 -->
      <div id="loading" class="alert alert-secondary mx-3" role="alert">正在從 Google 試算表載入資料…</div>
      <div id="error" class="alert alert-danger d-none mx-3" role="alert"></div>

      <!-- 表格 -->
      <div class="table-responsive px-3">
        <table id="dataTable" class="table table-striped table-hover align-middle table-fixed-header table-center mb-0">
          <thead class="table-light">
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      // ==== 設定 ====
      const API_KEY = "AIzaSyD14dE-5ouFvIxnTrwF3zhHqFhh9OW0q8c";
      const SHEET_ID = "1vFrSu2c0UWTeyKdDcNwuwVUOSKHdRuTZ3PwzcoLyLEo";
      const SHEET_NAME = "健管學員清單";

      const SOURCE_HEADERS = ["狀態", "第幾天", "學員姓名", "專屬教練", "開始日期", "結束日期", "今日菜單"];
      const DISPLAY_HEADERS = ["狀態", "學員姓名", "天數", "週數", "專屬教練", "執行日期", "今日菜單"];
      const MOBILE_KEEP = new Set(["狀態", "學員姓名", "天數", "週數", "專屬教練", "今日菜單"]);
      const MAX_DAYS = 45;

      // 地圖顯示哪些狀態（空陣列=全部；只要進行中→改成 ["進行中"]）
      const BOARD_STATUS_WHITELIST = []; // ["進行中"]

      // ==== DOM ====
      const $loading = document.getElementById("loading");
      const $error = document.getElementById("error");
      const $thead = document.getElementById("theadRow");
      const $tbody = document.getElementById("tbody");
      const $filter = document.getElementById("filterInput");
      const $reload = document.getElementById("reloadBtn");
      const $board = document.getElementById("boardGrid");

      let _rawRows = []; // 關鍵字篩選基底

      // 初次載入
      buildBoard();
      fetchAndRender();

      // 綁定事件
      $reload.addEventListener("click", fetchAndRender);
      $filter.addEventListener("input", () => {
        applyFilter();
        afterLayout(handleResize);
      });
      window.addEventListener(
        "resize",
        debounce(() => afterLayout(handleResize), 100)
      );
      window.addEventListener("load", () => afterLayout(handleResize));

      function isMobile() {
        return window.matchMedia("(max-width: 576px)").matches;
      }
      function colClass(headerDisplay) {
        return MOBILE_KEEP.has(headerDisplay) ? "" : "d-none d-sm-table-cell";
      }

      // === 生成 45 天地圖（每週左到右） ===
      function buildBoard() {
        $board.innerHTML = "";
        for (let w = 1; w <= 7; w++) {
          const row = document.createElement("div");
          row.className = "board-row";

          // 週數標籤
          const tag = document.createElement("div");
          tag.className = `week-tag c${w}`;
          tag.textContent = `第${numToZh(w)}週`;
          row.appendChild(tag);

          // 7 天容器（flex）
          const days = document.createElement("div");
          days.className = "days-row";
          for (let c = 1; c <= 7; c++) {
            const dayAbs = (w - 1) * 7 + c;
            const cell = document.createElement("div");
            cell.className = "board-cell";
            cell.id = `cell-day-${dayAbs}`;
            cell.dataset.day = String(dayAbs);
            cell.dataset.col = String(c); // 直欄索引 1..7
            cell.innerHTML = `
              <div class="day-label">${dayAbs}</div>
              <div class="names-full"></div>
            `;
            days.appendChild(cell);
          }
          row.appendChild(days);
          $board.appendChild(row);
        }
      }

      async function fetchAndRender() {
        toggleLoading(true);
        clearError();
        $tbody.innerHTML = "";
        $thead.innerHTML = DISPLAY_HEADERS.map((h) => `<th scope="col" class="${colClass(h)}">${h}</th>`).join("");

        try {
          const rangeA1 = `${SHEET_NAME}!A:Z`;
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(rangeA1)}?key=${API_KEY}`;
          const resp = await fetch(url, { method: "GET" });
          if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
          const data = await resp.json();

          const values = data.values || [];
          if (!values.length) {
            showError("工作表沒有資料。");
            toggleLoading(false);
            return;
          }

          const headerRow = values[0].map((v) => (v ?? "").trim());
          const bodyRows = values.slice(1);

          const colIndexByLabel = {};
          headerRow.forEach((label, idx) => {
            if (label) colIndexByLabel[label] = idx;
          });

          const missing = SOURCE_HEADERS.filter((h) => !(h in colIndexByLabel));
          if (missing.length) showError(`下列表頭在工作表中找不到：${missing.join("、")}。請確認表頭文字一致。`);

          const nameIdx = colIndexByLabel["學員姓名"];
          const dayIdx = colIndexByLabel["第幾天"];
          const startIdx = colIndexByLabel["開始日期"];
          const endIdx = colIndexByLabel["結束日期"];

          const records = [];
          for (const row of bodyRows) {
            if (!row || row.every((cell) => String(cell || "").trim() === "")) continue;
            const nameVal = Number.isInteger(nameIdx) ? String(row[nameIdx] ?? "").trim() : "";
            if (!nameVal) continue;

            const statusTxt = getCell(row, colIndexByLabel["狀態"]);
            const isCompleted = /已完成/i.test(statusTxt);
            const startRaw = getCell(row, startIdx);
            const startDate = parseSheetDate(startRaw);

            records.push({ row, statusTxt, isCompleted, startDate });
          }

          // 排序：已完成放最後；其餘依開始日期由早到晚
          records.sort((a, b) => {
            if (a.isCompleted !== b.isCompleted) return a.isCompleted ? 1 : -1;
            const ta = a.startDate ? a.startDate.getTime() : Number.POSITIVE_INFINITY;
            const tb = b.startDate ? b.startDate.getTime() : Number.POSITIVE_INFINITY;
            return ta - tb;
          });

          // 表格渲染
          const rowsHtml = [];
          _rawRows = [];
          for (const rec of records) {
            const { row, statusTxt, isCompleted } = rec;
            const tds = [];
            const rowTextCollector = [];

            for (const headerDisplay of DISPLAY_HEADERS) {
              if (headerDisplay === "週數") {
                let weekNum = 0;
                const n = Number(getCell(row, dayIdx));
                if (Number.isFinite(n) && n > 0 && n <= MAX_DAYS) weekNum = Math.ceil(n / 7);
                const weekNumToRender = isCompleted ? 7 : weekNum;
                tds.push(`<td class="${colClass(headerDisplay)}">${renderWeekGridResponsive(weekNumToRender)}</td>`);
                rowTextCollector.push(String(weekNumToRender || ""));
                continue;
              }

              if (headerDisplay === "執行日期") {
                const startTxtRaw = getCell(row, startIdx);
                const endTxtRaw = getCell(row, endIdx);
                const startDisp = formatDateDisplay(startTxtRaw);
                const endDisp = formatDateDisplay(endTxtRaw);
                const cellHtml =
                  startDisp || endDisp
                    ? `<div class="d-flex flex-column align-items-center">
                       <span class="fw-semibold">${escapeHtml(startDisp)}</span>
                       <span class="text-secondary small">${escapeHtml(endDisp)}</span>
                     </div>`
                    : "";
                tds.push(`<td class="${colClass(headerDisplay)}">${cellHtml}</td>`);
                rowTextCollector.push(`${startDisp} ${endDisp}`);
                continue;
              }

              // 對應來源表頭
              let sourceHeader = headerDisplay;
              if (headerDisplay === "天數") sourceHeader = "第幾天";
              const idx = colIndexByLabel[sourceHeader];
              const txt = getCell(row, idx);

              if (sourceHeader === "狀態") {
                const s = (statusTxt || txt || "").trim();
                let badgeCls = "bg-secondary text-white";
                let dotBg = "bg-secondary";
                if (/已完成/i.test(s)) {
                  badgeCls = "bg-primary text-white";
                  dotBg = "bg-primary";
                } else if (/未開始/i.test(s)) {
                  badgeCls = "bg-light text-dark border";
                  dotBg = "bg-light";
                } else if (/進行中/i.test(s)) {
                  badgeCls = "bg-success text-white";
                  dotBg = "bg-success";
                }
                const desktop = `<span class="badge ${badgeCls} badge-status d-none d-sm-inline-block">${escapeHtml(s)}</span>`;
                const mobile = `<span class="status-dot ${dotBg} d-inline-block d-sm-none" title="${escapeHtml(s)}" aria-label="${escapeHtml(s)}"></span>`;
                tds.push(`<td class="${colClass(headerDisplay)}">${desktop}${mobile}</td>`);
              } else if (sourceHeader === "今日菜單" && txt) {
                const s = txt.replace(/\s/g, "");
                let cls = "";
                if (/^(準備日|準)$/i.test(s)) cls = "bg-danger text-white";
                else if (/^(纖體日|纖)$/i.test(s)) cls = "bg-success text-white";
                else if (/^(蛋白日|蛋)$/i.test(s)) cls = "bg-secondary text-white";
                else if (/^(新陳代謝日|代)$/i.test(s)) cls = "bg-primary text-white";
                if (cls) tds.push(`<td class="${colClass(headerDisplay)}"><span class="badge ${cls} badge-menu">${escapeHtml(txt)}</span></td>`);
                else tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
              } else {
                tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
              }

              rowTextCollector.push(txt);
            }
            _rawRows.push(rowTextCollector.join(" ").toLowerCase());
            rowsHtml.push(`<tr>${tds.join("")}</tr>`);
          }
          $tbody.innerHTML = rowsHtml.join("");
          applyFilter();

          // 地圖渲染：把名字放到對應天數（支援 /／\＼ 分割多名）
          renderBoardNames(records, colIndexByLabel);

          // 完成 DOM 後：做手機姓名/欄寬調整，再設置「全空週的固定高度」
          afterLayout(handleResize);
        } catch (err) {
          showError("讀取失敗：" + (err?.message || err));
        } finally {
          toggleLoading(false);
        }
      }

      // 把學員名字放到對應格子
      function renderBoardNames(records, colIndexByLabel) {
        document.querySelectorAll(".board-cell .names-full").forEach((el) => (el.innerHTML = ""));

        const nameIdx = colIndexByLabel["學員姓名"];
        const dayIdx = colIndexByLabel["第幾天"];
        const statusIdx = colIndexByLabel["狀態"];
        const SPLIT_RE = /[\/／﹨＼]/;

        const dayMap = new Map(); // day -> names[]
        for (const rec of records) {
          const status = getCell(rec.row, statusIdx);
          const keep = BOARD_STATUS_WHITELIST.length === 0 || BOARD_STATUS_WHITELIST.some((s) => status.includes(s));
          if (!keep) continue;

          const raw = getCell(rec.row, nameIdx);
          const parts = raw
            .split(SPLIT_RE)
            .map((s) => s.trim())
            .filter(Boolean);
          const nDay = Number(getCell(rec.row, dayIdx));
          if (!Number.isFinite(nDay) || nDay <= 0 || nDay > MAX_DAYS) continue;

          if (!dayMap.has(nDay)) dayMap.set(nDay, []);
          dayMap.get(nDay).push(...parts);
        }

        for (let day = 1; day <= MAX_DAYS; day++) {
          const names = dayMap.get(day) || [];
          const cell = document.getElementById(`cell-day-${day}`);
          if (!cell) continue;

          const wrap = cell.querySelector(".names-full");
          for (const name of names) {
            const r = document.createElement("div");
            r.className = "name-row";
            r.dataset.fullname = name; // 保留全名
            r.textContent = name; // 初始全名（手機稍後裁成倒數兩字）
            r.title = name;
            wrap.appendChild(r);
          }
        }
      }

      /* === 手機：姓名倒數兩字 + 依直欄統一寬度 === */
      function applyMobileNameTransform() {
        const isM = isMobile();

        // 還原全名（避免反覆切換造成裁切累積）
        document.querySelectorAll(".name-row").forEach((r) => {
          if (r.dataset.fullname) r.textContent = r.dataset.fullname;
        });
        // 清除欄寬分類
        document.querySelectorAll(".board-cell").forEach((cell) => {
          cell.classList.remove("col-wide", "col-narrow");
          cell.style.height = ""; // 清除可能的「全空週固定高度」
          cell.style.minHeight = "";
        });

        if (!isM) return;

        // 手機：姓名 → 倒數兩字
        document.querySelectorAll(".name-row").forEach((r) => {
          const full = r.dataset.fullname || r.textContent || "";
          r.textContent = lastTwo(full);
        });

        // 依直欄（1..7）判斷是否有姓名
        for (let c = 1; c <= 7; c++) {
          const cells = Array.from(document.querySelectorAll(`.board-cell[data-col="${c}"]`));
          const hasNameInColumn = cells.some((cell) => cell.querySelector(".name-row"));
          const cls = hasNameInColumn ? "col-wide" : "col-narrow";
          cells.forEach((cell) => cell.classList.add(cls));
        }
      }

      // ★ 只有整週沒有姓名時，才把該 row 的 7 格設為「與週標籤同高」
      function adjustWeekMinHeights() {
        const rows = Array.from(document.querySelectorAll("#boardGrid .board-row"));
        const mobile = isMobile();

        rows.forEach((row) => {
          const tag = row.querySelector(".week-tag");
          const cells = Array.from(row.querySelectorAll(".board-cell"));
          if (!cells.length) return;

          // 先清掉舊的 inline 限制
          cells.forEach((cell) => {
            cell.style.height = "";
            cell.style.minHeight = "";
          });

          // 判斷這週是否完全沒有姓名
          const hasAnyName = cells.some((cell) => cell.querySelector(".name-row"));
          if (!hasAnyName) {
            // 量週標籤高度（以一致的三字「週數」量測）
            let tagH = 0;
            if (tag) {
              const original = tag.textContent;
              tag.textContent = "週數";
              tagH = Math.ceil(tag.getBoundingClientRect().height);
              tag.textContent = original;
            }
            if (!tagH || tagH < 40) tagH = 40; // 後備值

            const floor = mobile ? 100 : 150; // ★ 手機 100、桌機 150
            const minH = Math.max(tagH, floor);

            // 用 minHeight（不是 height）→ 不會蓋掉 CSS 的更高需求
            cells.forEach((cell) => {
              cell.style.minHeight = `${minH}px`;
            });
          }
          // 有姓名的週：不設 inline 高度，讓內容自然撐高，
          // 同時交給 CSS 的 min-height 100/150 做底線。
        });
      }

      // 計算順序：手機姓名/欄寬 → 若整週全空則設定固定高度
      function handleResize() {
        applyMobileNameTransform();
        adjustWeekMinHeights();
      }

      // 兩次 rAF 之後再執行，確保 DOM/樣式都完成佈局
      function afterLayout(fn) {
        requestAnimationFrame(() => requestAnimationFrame(fn));
      }

      // 工具：防抖
      function debounce(fn, wait) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(null, args), wait);
        };
      }

      function applyFilter() {
        const q = ($filter.value || "").trim().toLowerCase();
        const trs = $tbody.querySelectorAll("tr");
        if (!q) {
          trs.forEach((tr) => tr.classList.remove("d-none"));
          return;
        }
        trs.forEach((tr, i) => {
          const hit = _rawRows[i]?.includes(q);
          tr.classList.toggle("d-none", !hit);
        });
      }

      // === 小工具 ===
      function lastTwo(str) {
        const arr = Array.from(String(str).trim());
        return arr.length <= 2 ? arr.join("") : arr.slice(-2).join("");
      }
      function numToZh(n) {
        return ["一", "二", "三", "四", "五", "六", "七"][n - 1] || String(n);
      }
      function getCell(row, idx) {
        return Number.isInteger(idx) && row[idx] != null ? String(row[idx]).trim() : "";
      }

      // 週數渲染（彩虹進度）
      function renderWeekGridResponsive(weekNum) {
        let grid = '<div class="week-grid d-none d-sm-inline-flex" aria-label="週數進度">';
        for (let i = 1; i <= 7; i++) {
          const cls = weekNum >= i && i <= 7 ? `week-box c${i}` : "week-box inactive";
          grid += `<span class="${cls}" title="第 ${i} 週">${i}</span>`;
        }
        grid += "</div>";
        let mobile;
        if (weekNum >= 1 && weekNum <= 7) {
          mobile = `<span class="week-box c${weekNum} d-inline-flex d-sm-none" title="第 ${weekNum} 週">${weekNum}</span>`;
        } else {
          mobile = `<span class="week-box inactive d-inline-flex d-sm-none" title="週數無效">–</span>`;
        }
        return grid + mobile;
      }

      // 友善日期顯示
      function formatDateDisplay(val) {
        const d = parseSheetDate(val);
        if (!d) return String(val || "").trim();
        const y = d.getFullYear(),
          m = String(d.getMonth() + 1).padStart(2, "0"),
          dd = String(d.getDate()).padStart(2, "0");
        return `${y}/${m}/${dd}`;
      }

      // 解析日期 / Sheets 序列
      function parseSheetDate(val) {
        if (val == null) return null;
        const s = String(val).trim();
        if (!s) return null;
        if (/^\d+(\.\d+)?$/.test(s)) {
          const n = Number(s);
          if (Number.isFinite(n) && n > 30000 && n < 70000) return serialToDate(n);
        }
        const norm = s.replace(/\./g, "-").replace(/\//g, "-");
        const parts = norm.split("-");
        if (parts.length === 3) {
          const [a, b, c] = parts;
          if (a.length === 4) {
            const d = new Date(Number(a), Number(b) - 1, Number(c));
            if (!isNaN(d)) return d;
          } else if (c.length === 4) {
            const d = new Date(Number(c), Number(a) - 1, Number(b));
            if (!isNaN(d)) return d;
          }
        }
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }
      function serialToDate(n) {
        const epoch = Date.UTC(1899, 11, 30);
        return new Date(epoch + n * 86400 * 1000);
      }
      function escapeHtml(str) {
        return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
      }
      function toggleLoading(show) {
        $loading.classList.toggle("d-none", !show);
      }
      function showError(msg) {
        $error.textContent = msg;
        $error.classList.remove("d-none");
      }
      function clearError() {
        $error.textContent = "";
        $error.classList.add("d-none");
      }
    </script>
  </body>
</html>
