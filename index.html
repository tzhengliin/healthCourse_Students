<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>高雄博士班-健管學員清單</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* 頂部留白；左右 0 */
      body {
        margin: 0;
        padding: 12px 0 0 0;
        padding-top: max(12px, env(safe-area-inset-top));
      }

      .table-fixed-header thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
      }

      /* ===== 進度地圖容器 ===== */
      .board-wrap {
        width: 100%;
      }
      .board-grid {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }

      /* 每行：左側週標籤 + 右側 7 格（右側用 flex，讓同一 row 自動等高） */
      .board-row {
        display: grid;
        grid-template-columns: 40px 1fr;
        gap: 8px;
        width: 100%;
      }
      .days-row {
        display: flex;
        gap: 8px;
        width: 100%;
        align-items: stretch;
      }

      /* 垂直週數標籤（用 c1~c7 套色） */
      .week-tag {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        color: #fff;
        font-weight: 800;
        letter-spacing: 0.05em;
        border: 1px solid rgba(0, 0, 0, 0.06);
        padding: 4px 0;
        user-select: none;
      }

      /* 天數方格：高度由內容自然撐開（僅在整週全空時以 JS 設定固定高度） */
      .board-cell {
        position: relative;
        border-radius: 12px;
        border: 1px solid #d5e8d5;
        background: #edf7ee;
        flex: 1 1 0;
        padding-top: 26px; /* 預留上方給 day-label */
        overflow: visible;
      }
      .day-label {
        position: absolute;
        top: 4px;
        left: 6px;
        font-weight: 800;
        font-size: 0.9rem;
        color: #164e22;
        text-shadow: 0 1px 0 rgba(255, 255, 255, 0.7);
        pointer-events: none;
      }

      /* 姓名容器：走正常文流（參與高度計算） */
      .names-full {
        position: static;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        gap: 4px;
      }
      .name-row {
        width: 100%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        text-align: center;
        font-weight: 800;
        line-height: 1.2;
        color: #0f5132;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        padding: 3px 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 18px; /* 電腦版固定 18px（手機會覆寫） */
      }
      .name-text {
        display: inline-block;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      /* 今日餐點圓點（單字＋底色） */
      .menu-dot {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 900;
        line-height: 1;
        border: 1px solid transparent;
        flex: 0 0 18px;
      }
      .dot-prep {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
      } /* 準備日：紅 */
      .dot-protein {
        background: #fff3cd;
        color: #7a5e00;
        border-color: #ffe69c;
      } /* 蛋白日：淡黃 */
      .dot-slim {
        background: #22c55e;
        color: #fff;
        border-color: #22c55e;
      } /* 纖體日：綠 */
      .dot-meta {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
      } /* 新陳代謝：藍 */

      /* ===== 手機（<=576px）規則 ===== */
      @media (max-width: 576px) {
        .board-cell {
          flex: 2 1 0;
          min-height: 100px;
        }
        .board-cell.col-wide {
          flex: 3 1 0;
        }
        .board-cell.col-narrow {
          flex: 1 1 0;
        }

        .name-row {
          font-size: 12px !important;
          padding: 2px 4px;
        }
        .day-label {
          font-size: 0.8rem;
        }
      }

      /* 桌機最小 150px */
      @media (min-width: 577px) {
        .board-cell {
          min-height: 150px;
        }
      }

      /* ===== 下方表格 ===== */
      .badge-status {
        font-weight: 700;
        font-size: 1rem;
        padding: 0.5em 0.65em;
        line-height: 1;
      }
      .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid var(--bs-border-color, #dee2e6);
        vertical-align: middle;
      }
      .badge-menu {
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.45em 0.6em;
        line-height: 1;
      }
      .table-center thead th,
      .table-center tbody td {
        text-align: center;
        vertical-align: middle;
      }

      .week-grid {
        display: inline-flex;
        gap: 0.3rem;
        justify-content: center;
        align-items: center;
      }
      .week-box {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 800;
        font-size: 0.9rem;
        user-select: none;
        border: 1px solid var(--bs-border-color, #dee2e6);
      }
      .week-box.inactive {
        background: var(--bs-light);
        color: var(--bs-secondary);
      }

      /* 週色（表格與週標籤共用） */
      .c1 {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
        box-shadow: 0 0 0 0.12rem rgba(239, 68, 68, 0.15);
      }
      .c2 {
        background: #f59e0b;
        color: #111;
        border-color: #f59e0b;
        box-shadow: 0 0 0 0.12rem rgba(245, 158, 11, 0.15);
      }
      .c3 {
        background: #facc15;
        color: #111;
        border-color: #facc15;
        box-shadow: 0 0 0 0.12rem rgba(250, 204, 21, 0.2);
      }
      .c4 {
        background: #22c55e;
        color: #fff;
        border-color: #22c55e;
        box-shadow: 0 0 0 0.12rem rgba(34, 197, 94, 0.18);
      }
      .c5 {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.12rem rgba(59, 130, 246, 0.18);
      }
      .c6 {
        background: #6366f1;
        color: #fff;
        border-color: #6366f1;
        box-shadow: 0 0 0 0.12rem rgba(99, 102, 241, 0.18);
      }
      .c7 {
        background: #a855f7;
        color: #fff;
        border-color: #a855f7;
        box-shadow: 0 0 0 0.12rem rgba(168, 85, 247, 0.18);
      }

      /* ===== Modal 內 45 天日曆 ===== */
      .calendar-45 {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }
      .cal-cell {
        border: 1px solid var(--bs-border-color, #dee2e6);
        border-radius: 0.5rem;
        padding: 6px;
        min-height: 84px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        justify-content: flex-start;
        text-align: center;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
      }
      .cal-muted {
        background: var(--bs-light);
        color: var(--bs-secondary);
      }
      .cal-active {
        background: #f8fbff;
        border-color: #b6e0fe;
      }

      .cal-head {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* 天數圈圈：無外框、白底黑字（字稍小） */
      .cal-idx {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 0;
        background: #fff;
        color: #000;
        font-weight: 800;
        font-size: 0.8rem;
        line-height: 1;
      }

      /* 日期（MM/DD）加大加粗 */
      .cal-date {
        font-weight: 900;
        color: inherit;
        font-size: 1.15rem;
        letter-spacing: 0.02em;
      }

      /* 當日菜單：縮小、單行、省略號，不換行 */
      .cal-menu {
        font-size: 0.95rem;
        font-weight: 900;
        letter-spacing: 0.02em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }

      /* 整格上色 */
      .day-prep {
        background: #ef4444 !important;
        color: #fff !important;
        border-color: #ef4444 !important;
      }
      .day-protein {
        background: #fff3cd !important;
        color: #7a5e00 !important;
        border-color: #ffe69c !important;
      }
      .day-slim {
        background: #22c55e !important;
        color: #fff !important;
        border-color: #22c55e !important;
      }
      .day-meta {
        background: #3b82f6 !important;
        color: #fff !important;
        border-color: #3b82f6 !important;
      }

      /* === 截圖區塊（加白底與留白邊界） === */
      .capture-frame {
        background: #ffffff;
        padding: 28px; /* 留白 */
        border-radius: 8px;
        box-sizing: border-box;
        display: inline-block; /* 讓寬度跟內容走，避免被容器壓縮 */
        overflow: visible; /* 確保不裁切 */
      }
      .capture-title {
        font-weight: 900;
        text-align: center;
        font-size: 1.2rem;
        letter-spacing: 0.02em;
        margin-bottom: 6px;
        color: #000;
      }
      .capture-sub {
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container-fluid px-0">
      <h1 class="h3 mb-3 px-3 text-center">高雄博士班-健管45學員清單</h1>
      <!-- ===== 進度地圖區塊 ===== -->
      <div class="board-wrap px-3 mb-3">
        <h2 class="h5 mb-2">每週學員進度圖</h2>
        <div id="boardGrid" class="board-grid" aria-label="健管 45 天（每週左到右）"></div>
      </div>

      <!-- 篩選 + 重新讀取 -->
      <div class="row g-2 align-items-center mb-3 px-3">
        <div class="col-auto"><label for="filterInput" class="col-form-label">關鍵字篩選：</label></div>
        <div class="col-12 col-sm-6 col-md-4"><input type="text" id="filterInput" class="form-control" placeholder="輸入姓名 / 教練 / 狀態 / 菜單 …" /></div>
        <div class="col-auto"><button id="reloadBtn" class="btn btn-outline-primary">重新讀取</button></div>
      </div>

      <!-- 載入中 / 錯誤 -->
      <div id="loading" class="alert alert-secondary mx-3" role="alert">正在從 Google 試算表載入資料…</div>
      <div id="error" class="alert alert-danger d-none mx-3" role="alert"></div>

      <!-- 表格 -->
      <div class="table-responsive px-3">
        <table id="dataTable" class="table table-striped table-hover align-middle table-fixed-header table-center mb-0">
          <thead class="table-light">
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ===== Modal：總菜單 45 天日曆 ===== -->
    <div class="modal fade" id="menuModal" tabindex="-1" aria-hidden="true">
      <!-- 更大的 modal-xl；小螢幕全螢幕 -->
      <div class="modal-dialog modal-xl modal-fullscreen-sm-down modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><span id="modalName"></span> 的 45 天日曆</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
          </div>
          <div class="modal-body">
            <!-- ★ 下載截圖的擷取區（標題 + 期間 + 日曆） -->
            <div id="calendarCapture" class="capture-frame">
              <h4 id="captureTitle" class="capture-title"></h4>
              <div id="modalDateRange" class="mb-2 text-secondary small capture-sub"></div>
              <div id="calendarWrap" class="calendar-45"></div>
            </div>
            <div id="calendarNote" class="alert alert-warning mt-3 d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-primary" id="btnDownloadImage" disabled>下載圖片</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS（Modal 需要） -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 用於把 DOM 截成圖片 -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
      // ==== 設定 ====
      const API_KEY = "AIzaSyD14dE-5ouFvIxnTrwF3zhHqFhh9OW0q8c";
      const SHEET_ID = "1vFrSu2c0UWTeyKdDcNwuwVUOSKHdRuTZ3PwzcoLyLEo";
      const SHEET_MAIN = "健管學員清單";
      const SHEET_MENU = "學員菜單";

      const SOURCE_HEADERS = ["狀態", "第幾天", "學員姓名", "專屬教練", "開始日期", "結束日期", "今日菜單"];
      const DISPLAY_HEADERS = ["狀態", "學員姓名", "天數", "週數", "專屬教練", "執行日期", "今日菜單", "總菜單"];
      const MOBILE_KEEP = new Set(["狀態", "學員姓名", "天數", "週數", "專屬教練", "今日菜單", "總菜單"]);
      const MAX_DAYS = 45;

      const BOARD_STATUS_WHITELIST = []; // ["進行中"]

      // ==== DOM ====
      const $loading = document.getElementById("loading");
      const $error = document.getElementById("error");
      const $thead = document.getElementById("theadRow");
      const $tbody = document.getElementById("tbody");
      const $filter = document.getElementById("filterInput");
      const $reload = document.getElementById("reloadBtn");
      const $board = document.getElementById("boardGrid");

      // Modal DOM
      const $menuModal = document.getElementById("menuModal");
      const $modalName = document.getElementById("modalName");
      const $captureTitle = document.getElementById("captureTitle");
      const $modalDateRange = document.getElementById("modalDateRange");
      const $calendarWrap = document.getElementById("calendarWrap");
      const $calendarNote = document.getElementById("calendarNote");
      const $calendarCapture = document.getElementById("calendarCapture");
      const $btnDownloadImage = document.getElementById("btnDownloadImage");

      let _rawRows = []; // 關鍵字篩選基底
      const MENU_BY_NAME = new Map(); // name -> {1:'準備日',...}

      const SPLIT_RE = /[\/／﹨＼]/;

      // 初次載入
      buildBoard();
      fetchAndRender();

      // 事件
      $reload.addEventListener("click", fetchAndRender);
      $filter.addEventListener("input", () => {
        applyFilter();
        afterLayout(handleResize);
      });
      window.addEventListener(
        "resize",
        debounce(() => afterLayout(handleResize), 100)
      );
      window.addEventListener("load", () => afterLayout(handleResize));

      // Modal：攔截顯示事件，建立日曆並啟用下載鍵
      $menuModal.addEventListener("show.bs.modal", (ev) => {
        const trigger = ev.relatedTarget;
        if (!trigger) return;
        const name = trigger.getAttribute("data-name") || "";
        const startRaw = trigger.getAttribute("data-start") || "";
        const endRaw = trigger.getAttribute("data-end") || "";
        openCalendarFor({ name, startRaw, endRaw });
      });

      // 下載：把 calendarCapture 區域轉成 PNG（使用 scrollWidth/scrollHeight，避免右側被裁）
      $btnDownloadImage.addEventListener("click", async () => {
        try {
          $btnDownloadImage.disabled = true;
          $btnDownloadImage.textContent = "產生中…";

          const el = $calendarCapture;

          // 用實際內容尺寸（含 padding）
          const w = Math.ceil(el.scrollWidth);
          const h = Math.ceil(el.scrollHeight);

          const canvas = await html2canvas(el, {
            backgroundColor: "#ffffff",
            useCORS: true,
            scale: Math.min(2, window.devicePixelRatio || 1.5),
            width: w,
            height: h,
            windowWidth: Math.max(w, document.documentElement.clientWidth),
            windowHeight: Math.max(h, document.documentElement.clientHeight),
            scrollX: 0,
            scrollY: -window.scrollY, // 避免頁面捲動影響
            onclone: (doc) => {
              const cap = doc.getElementById("calendarCapture");
              if (cap) {
                cap.style.display = "inline-block";
                cap.style.overflow = "visible";
                cap.style.background = "#ffffff";
                cap.style.padding = getComputedStyle($calendarCapture).padding; // 保持相同留白
              }
            },
          });

          canvas.toBlob((blob) => {
            if (!blob) return;
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = buildDownloadFilename();
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(a.href);
            a.remove();
          }, "image/png");
        } catch (e) {
          alert("下載失敗，請再試一次。");
          console.error(e);
        } finally {
          $btnDownloadImage.textContent = "下載圖片";
          $btnDownloadImage.disabled = false;
        }
      });

      function buildDownloadFilename() {
        const name = ($modalName.textContent || "學員").replace(/\s+/g, "");
        const range = ($modalDateRange.textContent || "")
          .replace(/[^0-9\-\/～]/g, "")
          .replaceAll("/", "")
          .replace("期間：", "")
          .replace("（最多顯示 45 天）", "")
          .replace(/\s+/g, "");
        const m = range.match(/(\d{4}\d{2}\d{2}).*?(\d{4}\d{2}\d{2})/);
        const span = m ? `${m[1]}-${m[2]}` : "期間";
        return `菜單_${name}_${span}.png`;
      }

      function isMobile() {
        return window.matchMedia("(max-width: 576px)").matches;
      }
      function colClass(headerDisplay) {
        return MOBILE_KEEP.has(headerDisplay) ? "" : "d-none d-sm-table-cell";
      }

      // === 生成 45 天地圖 ===
      function buildBoard() {
        $board.innerHTML = "";
        for (let w = 1; w <= 7; w++) {
          const row = document.createElement("div");
          row.className = "board-row";

          const tag = document.createElement("div");
          tag.className = `week-tag c${w}`;
          tag.textContent = `第${numToZh(w)}週`;
          row.appendChild(tag);

          const days = document.createElement("div");
          days.className = "days-row";
          for (let c = 1; c <= 7; c++) {
            const dayAbs = (w - 1) * 7 + c;
            const cell = document.createElement("div");
            cell.className = "board-cell";
            cell.id = `cell-day-${dayAbs}`;
            cell.dataset.day = String(dayAbs);
            cell.dataset.col = String(c);
            cell.innerHTML = `
              <div class="day-label">${dayAbs}</div>
              <div class="names-full"></div>
            `;
            days.appendChild(cell);
          }
          row.appendChild(days);
          $board.appendChild(row);
        }
      }

      async function fetchAndRender() {
        toggleLoading(true);
        clearError();
        $tbody.innerHTML = "";
        $thead.innerHTML = DISPLAY_HEADERS.map((h) => `<th scope="col" class="${colClass(h)}">${h}</th>`).join("");

        try {
          // 兩張分頁並行抓取
          const mainRange = `${SHEET_MAIN}!A:Z`;
          const menuRange = `${SHEET_MENU}!A:AZ`;
          const mainUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(mainRange)}?key=${API_KEY}`;
          const menuUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(menuRange)}?key=${API_KEY}`;

          const [respMain, respMenu] = await Promise.all([fetch(mainUrl), fetch(menuUrl)]);
          if (!respMain.ok) throw new Error(`主表 HTTP ${respMain.status} ${respMain.statusText}`);
          if (!respMenu.ok) throw new Error(`菜單表 HTTP ${respMenu.status} ${respMenu.statusText}`);

          const dataMain = await respMain.json();
          const dataMenu = await respMenu.json();

          // === 主表處理 ===
          const values = dataMain.values || [];
          if (!values.length) {
            showError("工作表沒有資料。");
            toggleLoading(false);
            return;
          }
          const headerRow = values[0].map((v) => (v ?? "").trim());
          const bodyRows = values.slice(1);

          const colIndexByLabel = {};
          headerRow.forEach((label, idx) => {
            if (label) colIndexByLabel[label] = idx;
          });

          const missing = SOURCE_HEADERS.filter((h) => !(h in colIndexByLabel));
          if (missing.length) showError(`下列表頭在「${SHEET_MAIN}」找不到：${missing.join("、")}。請確認表頭文字一致。`);

          const nameIdx = colIndexByLabel["學員姓名"];
          const dayIdx = colIndexByLabel["第幾天"];
          const startIdx = colIndexByLabel["開始日期"];
          const endIdx = colIndexByLabel["結束日期"];
          const menuIdx = colIndexByLabel["今日菜單"];

          // === 菜單分頁處理 ===
          buildMenuMap(dataMenu.values || []);

          // === 原始記錄（排序、地圖） ===
          const records = [];
          for (const row of bodyRows) {
            if (!row || row.every((cell) => String(cell || "").trim() === "")) continue;
            const nameVal = Number.isInteger(nameIdx) ? String(row[nameIdx] ?? "").trim() : "";
            if (!nameVal) continue;

            const statusTxt = getCell(row, colIndexByLabel["狀態"]);
            const isCompleted = /已完成/i.test(statusTxt);
            const startRaw = getCell(row, startIdx);
            const startDate = parseSheetDate(startRaw);

            records.push({ row, statusTxt, isCompleted, startDate });
          }

          // 排序：已完成放最後；其餘依開始日期由早到晚
          records.sort((a, b) => {
            if (a.isCompleted !== b.isCompleted) return a.isCompleted ? 1 : -1;
            const ta = a.startDate ? a.startDate.getTime() : Number.POSITIVE_INFINITY;
            const tb = b.startDate ? b.startDate.getTime() : Number.POSITIVE_INFINITY;
            return ta - tb;
          });

          // === 表格用：姓名用斜線分割成多筆 ===
          const tableItems = [];
          for (const rec of records) {
            const nameRaw = getCell(rec.row, nameIdx);
            const parts = nameRaw
              .split(SPLIT_RE)
              .map((s) => s.trim())
              .filter(Boolean);
            if (!parts.length) continue;
            for (const nm of parts) {
              tableItems.push({ row: rec.row, name: nm, statusTxt: rec.statusTxt, isCompleted: rec.isCompleted, startDate: rec.startDate });
            }
          }

          // 表格渲染
          const rowsHtml = [];
          _rawRows = [];
          for (const item of tableItems) {
            const { row, name, statusTxt, isCompleted } = item;
            const tds = [];
            const rowTextCollector = [];

            for (const headerDisplay of DISPLAY_HEADERS) {
              if (headerDisplay === "週數") {
                let weekNum = 0;
                const n = Number(getCell(row, dayIdx));
                if (Number.isFinite(n) && n > 0 && n <= MAX_DAYS) weekNum = Math.ceil(n / 7);
                const weekNumToRender = isCompleted ? 7 : weekNum;
                tds.push(`<td class="${colClass(headerDisplay)}">${renderWeekGridResponsive(weekNumToRender)}</td>`);
                rowTextCollector.push(String(weekNumToRender || ""));
                continue;
              }

              if (headerDisplay === "執行日期") {
                const startTxtRaw = getCell(row, startIdx);
                const endTxtRaw = getCell(row, endIdx);
                const startDisp = formatDateDisplay(startTxtRaw);
                const endDisp = formatDateDisplay(endTxtRaw);
                const cellHtml =
                  startDisp || endDisp
                    ? `<div class="d-flex flex-column align-items-center">
                       <span class="fw-semibold">${escapeHtml(startDisp)}</span>
                       <span class="text-secondary small">${escapeHtml(endDisp)}</span>
                     </div>`
                    : "";
                tds.push(`<td class="${colClass(headerDisplay)}">${cellHtml}</td>`);
                rowTextCollector.push(`${startDisp} ${endDisp}`);
                continue;
              }

              if (headerDisplay === "學員姓名") {
                tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(name)}</td>`);
                rowTextCollector.push(name);
                continue;
              }

              if (headerDisplay === "總菜單") {
                const startTxtRaw = getCell(row, startIdx);
                const endTxtRaw = getCell(row, endIdx);
                const btn = `
                  <button 
                    type="button" 
                    class="btn btn-sm btn-outline-primary btn-view-calendar"
                    data-bs-toggle="modal"
                    data-bs-target="#menuModal"
                    data-name="${escapeAttr(name)}"
                    data-start="${escapeAttr(startTxtRaw)}"
                    data-end="${escapeAttr(endTxtRaw)}"
                    title="檢視 45 天菜單"
                  >菜單</button>`;
                tds.push(`<td class="${colClass(headerDisplay)}">${btn}</td>`);
                rowTextCollector.push("菜單");
                continue;
              }

              // 對應來源表頭
              let sourceHeader = headerDisplay;
              if (headerDisplay === "天數") sourceHeader = "第幾天";
              const idx = colIndexByLabel[sourceHeader];
              const txt = getCell(row, idx);

              if (sourceHeader === "狀態") {
                const s = (statusTxt || txt || "").trim();
                let badgeCls = "bg-secondary text-white";
                let dotBg = "bg-secondary";
                if (/已完成/i.test(s)) {
                  badgeCls = "bg-primary text-white";
                  dotBg = "bg-primary";
                } else if (/未開始/i.test(s)) {
                  badgeCls = "bg-light text-dark border";
                  dotBg = "bg-light";
                } else if (/進行中/i.test(s)) {
                  badgeCls = "bg-success text-white";
                  dotBg = "bg-success";
                }
                const desktop = `<span class="badge ${badgeCls} badge-status d-none d-sm-inline-block">${escapeHtml(s)}</span>`;
                const mobile = `<span class="status-dot ${dotBg} d-inline-block d-sm-none" title="${escapeHtml(s)}" aria-label="${escapeHtml(s)}"></span>`;
                tds.push(`<td class="${colClass(headerDisplay)}">${desktop}${mobile}</td>`);
              } else if (sourceHeader === "今日菜單" && txt) {
                const mv = menuVisual(txt);
                if (mv) {
                  tds.push(`<td class="${colClass(headerDisplay)}"><span class="badge ${mv.badgeClass} badge-menu">${escapeHtml(mv.full)}</span></td>`);
                } else {
                  tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
                }
              } else {
                tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
              }

              rowTextCollector.push(txt);
            }
            _rawRows.push(rowTextCollector.join(" ").toLowerCase());
            rowsHtml.push(`<tr>${tds.join("")}</tr>`);
          }
          $tbody.innerHTML = rowsHtml.join("");
          applyFilter();

          // 地圖渲染
          renderBoardNames(records, colIndexByLabel);

          // 完成 DOM 後：手機姓名/欄寬調整 + 全空週固定高度
          afterLayout(handleResize);
        } catch (err) {
          showError("讀取失敗：" + (err?.message || err));
        } finally {
          toggleLoading(false);
        }
      }

      // 解析「學員菜單」分頁
      function buildMenuMap(values) {
        MENU_BY_NAME.clear();
        if (!values.length) return;

        const header = values[0].map((v) => (v ?? "").toString().trim());
        const dayColIdx = {}; // day -> idx
        for (let i = 1; i < header.length; i++) {
          const n = Number(header[i]);
          if (Number.isInteger(n) && n >= 1 && n <= MAX_DAYS) dayColIdx[n] = i;
        }

        for (let r = 1; r < values.length; r++) {
          const row = values[r] || [];
          const nameRaw = (row[0] ?? "").toString().trim();
          if (!nameRaw) continue;

          const names = nameRaw
            .split(SPLIT_RE)
            .map((s) => s.trim())
            .filter(Boolean);
          if (!names.length) continue;

          const perDay = {};
          for (let d = 1; d <= MAX_DAYS; d++) {
            const idx = dayColIdx[d];
            if (idx == null) continue;
            const txt = (row[idx] ?? "").toString().trim();
            if (txt) perDay[d] = txt;
          }

          for (const nm of names) {
            MENU_BY_NAME.set(normalizeName(nm), perDay);
          }
        }
      }

      // 地圖姓名渲染
      function renderBoardNames(records, colIndexByLabel) {
        document.querySelectorAll(".board-cell .names-full").forEach((el) => (el.innerHTML = ""));

        const nameIdx = colIndexByLabel["學員姓名"];
        const dayIdx = colIndexByLabel["第幾天"];
        const statusIdx = colIndexByLabel["狀態"];
        const menuIdx = colIndexByLabel["今日菜單"];

        const dayMap = new Map(); // day -> [{name, mv}]
        for (const rec of records) {
          const status = getCell(rec.row, statusIdx);
          const keep = BOARD_STATUS_WHITELIST.length === 0 || BOARD_STATUS_WHITELIST.some((s) => status.includes(s));
          if (!keep) continue;

          const rawName = getCell(rec.row, nameIdx);
          const parts = rawName
            .split(SPLIT_RE)
            .map((s) => s.trim())
            .filter(Boolean);
          const nDay = Number(getCell(rec.row, dayIdx));
          if (!Number.isFinite(nDay) || nDay <= 0 || nDay > MAX_DAYS) continue;

          const menuTxt = getCell(rec.row, menuIdx);
          const mv = menuVisual(menuTxt);

          if (!dayMap.has(nDay)) dayMap.set(nDay, []);
          for (const p of parts) dayMap.get(nDay).push({ name: p, mv });
        }

        for (let day = 1; day <= MAX_DAYS; day++) {
          const items = dayMap.get(day) || [];
          const cell = document.getElementById(`cell-day-${day}`);
          if (!cell) continue;

          const wrap = cell.querySelector(".names-full");
          for (const it of items) {
            const r = document.createElement("div");
            r.className = "name-row";
            r.dataset.fullname = it.name;

            if (it.mv) {
              const dot = document.createElement("span");
              dot.className = `menu-dot ${it.mv.dotClass}`;
              dot.textContent = it.mv.char;
              dot.title = it.mv.title;
              r.appendChild(dot);
            }

            const nt = document.createElement("span");
            nt.className = "name-text";
            nt.textContent = it.name;
            r.appendChild(nt);

            r.title = it.name;
            wrap.appendChild(r);
          }
        }
      }

      /* === 手機：姓名倒數兩字 + 依直欄統一寬度 === */
      function applyMobileNameTransform() {
        const isM = isMobile();

        // 還原全名
        document.querySelectorAll(".name-row").forEach((r) => {
          const nt = r.querySelector(".name-text");
          const full = r.dataset.fullname || nt?.textContent || "";
          if (nt) nt.textContent = full;
        });
        // 清除欄寬分類
        document.querySelectorAll(".board-cell").forEach((cell) => {
          cell.classList.remove("col-wide", "col-narrow");
          cell.style.height = "";
          cell.style.minHeight = "";
        });

        if (!isM) return;

        // 手機：姓名 → 倒數兩字
        document.querySelectorAll(".name-row").forEach((r) => {
          const full = r.dataset.fullname || "";
          const short = lastTwo(full);
          const nt = r.querySelector(".name-text");
          if (nt) nt.textContent = short;
        });

        // 依直欄（1..7）判斷是否有姓名
        for (let c = 1; c <= 7; c++) {
          const cells = Array.from(document.querySelectorAll(`.board-cell[data-col="${c}"]`));
          const hasNameInColumn = cells.some((cell) => cell.querySelector(".name-row"));
          const cls = hasNameInColumn ? "col-wide" : "col-narrow";
          cells.forEach((cell) => cell.classList.add(cls));
        }
      }

      // 整週無姓名 → 設定最小高度
      function adjustWeekMinHeights() {
        const rows = Array.from(document.querySelectorAll("#boardGrid .board-row"));
        const mobile = isMobile();

        rows.forEach((row) => {
          const tag = row.querySelector(".week-tag");
          const cells = Array.from(row.querySelectorAll(".board-cell"));
          if (!cells.length) return;

          cells.forEach((cell) => {
            cell.style.height = "";
            cell.style.minHeight = "";
          });

          const hasAnyName = cells.some((cell) => cell.querySelector(".name-row"));
          if (!hasAnyName) {
            let tagH = 0;
            if (tag) {
              const original = tag.textContent;
              tag.textContent = "週數";
              tagH = Math.ceil(tag.getBoundingClientRect().height);
              tag.textContent = original;
            }
            if (!tagH || tagH < 40) tagH = 40;
            const floor = mobile ? 100 : 150;
            const minH = Math.max(tagH, floor);
            cells.forEach((cell) => {
              cell.style.minHeight = `${minH}px`;
            });
          }
        });
      }

      function handleResize() {
        applyMobileNameTransform();
        adjustWeekMinHeights();
      }
      function afterLayout(fn) {
        requestAnimationFrame(() => requestAnimationFrame(fn));
      }
      function debounce(fn, wait) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(null, args), wait);
        };
      }

      function applyFilter() {
        const q = ($filter.value || "").trim().toLowerCase();
        const trs = $tbody.querySelectorAll("tr");
        if (!q) {
          trs.forEach((tr) => tr.classList.remove("d-none"));
          return;
        }
        trs.forEach((tr, i) => {
          const hit = _rawRows[i]?.includes(q);
          tr.classList.toggle("d-none", !hit);
        });
      }

      // === Modal：45 天日曆 ===
      function openCalendarFor({ name, startRaw, endRaw }) {
        $modalName.textContent = name || "";
        $captureTitle.textContent = `${name || ""} 的健康管理45天計畫`;
        $calendarWrap.innerHTML = "";
        $calendarNote.classList.add("d-none");
        $calendarNote.textContent = "";
        $modalDateRange.textContent = "";
        $btnDownloadImage.disabled = true; // 重設

        const start = parseSheetDate(startRaw);
        const end = parseSheetDate(endRaw);

        if (!start || !end || isNaN(+start) || isNaN(+end) || end < start) {
          $calendarNote.classList.remove("d-none");
          $calendarNote.textContent = "無法產生日曆：開始 / 結束日期缺失或格式不正確。";
          return;
        }

        $modalDateRange.textContent = `期間：${formatDateDisplay(startRaw)} ～ ${formatDateDisplay(endRaw)}（最多顯示 45 天）`;

        const menus = MENU_BY_NAME.get(normalizeName(name)) || {};

        for (let i = 1; i <= MAX_DAYS; i++) {
          const d = new Date(start);
          d.setDate(d.getDate() + (i - 1));
          const inRange = d >= start && d <= end;

          const cell = document.createElement("div");
          cell.className = "cal-cell";
          cell.classList.add(inRange ? "cal-active" : "cal-muted");

          const head = document.createElement("div");
          head.className = "cal-head";

          const idx = document.createElement("span");
          idx.className = "cal-idx";
          idx.textContent = i;

          const dateStr = document.createElement("span");
          const mm = String(d.getMonth() + 1).padStart(2, "0");
          const dd = String(d.getDate()).padStart(2, "0");
          dateStr.className = "cal-date";
          dateStr.textContent = `${mm}/${dd}`;

          head.appendChild(idx);
          head.appendChild(dateStr);

          const menuTextRaw = (menus[i] || "").toString().trim();
          const mv = menuVisual(menuTextRaw);
          const menu = document.createElement("div");
          menu.className = "cal-menu";
          if (menuTextRaw && inRange) {
            if (mv) {
              cell.classList.add(mv.cellClass);
              menu.textContent = mv.full;
              menu.title = mv.title;
            } else {
              menu.textContent = menuTextRaw;
            }
          } else {
            menu.textContent = "";
          }

          cell.appendChild(head);
          cell.appendChild(menu);
          $calendarWrap.appendChild(cell);
        }

        const hasAny = Object.keys(menus).length > 0;
        if (!hasAny) {
          $calendarNote.classList.remove("d-none");
          $calendarNote.textContent = "在「學員菜單」分頁找不到此學員的逐日菜單。請確認姓名是否一致。";
        }

        requestAnimationFrame(() => {
          $btnDownloadImage.disabled = false;
        });
      }

      // === 菜單對應 ===
      function menuVisual(val) {
        const raw = String(val || "").trim();
        const s = raw.replace(/\s/g, "");
        if (/^(準備日|準)$/i.test(s)) {
          return { char: "準", full: "準備日", title: "準備日", dotClass: "dot-prep", badgeClass: "bg-danger text-white", cellClass: "day-prep" };
        }
        if (/^(蛋白日|蛋)$/i.test(s)) {
          return { char: "蛋", full: "蛋白日", title: "蛋白日", dotClass: "dot-protein", badgeClass: "bg-warning-subtle text-dark border border-warning-subtle", cellClass: "day-protein" };
        }
        if (/^(纖體日|纖)$/i.test(s)) {
          return { char: "纖", full: "纖體日", title: "纖體日", dotClass: "dot-slim", badgeClass: "bg-success text-white", cellClass: "day-slim" };
        }
        if (/^(新陳代謝日|新|代)$/i.test(s)) {
          return { char: "新", full: "新陳代謝日", title: "新陳代謝日", dotClass: "dot-meta", badgeClass: "bg-primary text-white", cellClass: "day-meta" };
        }
        return null;
      }

      // === 小工具 ===
      function lastTwo(str) {
        const arr = Array.from(String(str).trim());
        return arr.length <= 2 ? arr.join("") : arr.slice(-2).join("");
      }
      function numToZh(n) {
        return ["一", "二", "三", "四", "五", "六", "七"][n - 1] || String(n);
      }
      function getCell(row, idx) {
        return Number.isInteger(idx) && row[idx] != null ? String(row[idx]).trim() : "";
      }
      function normalizeName(s) {
        return String(s || "")
          .trim()
          .replace(/\s+/g, "")
          .toLowerCase();
      }

      function renderWeekGridResponsive(weekNum) {
        let grid = '<div class="week-grid d-none d-sm-inline-flex" aria-label="週數進度">';
        for (let i = 1; i <= 7; i++) {
          const cls = weekNum >= i && i <= 7 ? `week-box c${i}` : "week-box inactive";
          grid += `<span class="${cls}" title="第 ${i} 週">${i}</span>`;
        }
        grid += "</div>";
        let mobile =
          weekNum >= 1 && weekNum <= 7
            ? `<span class="week-box c${weekNum} d-inline-flex d-sm-none" title="第 ${weekNum} 週">${weekNum}</span>`
            : `<span class="week-box inactive d-inline-flex d-sm-none" title="週數無效">–</span>`;
        return grid + mobile;
      }

      function formatDateDisplay(val) {
        const d = parseSheetDate(val);
        if (!d) return String(val || "").trim();
        const y = d.getFullYear(),
          m = String(d.getMonth() + 1).padStart(2, "0"),
          dd = String(d.getDate()).padStart(2, "0");
        return `${y}/${m}/${dd}`;
      }

      function parseSheetDate(val) {
        if (val == null) return null;
        const s = String(val).trim();
        if (!s) return null;
        if (/^\d+(\.\d+)?$/.test(s)) {
          const n = Number(s);
          if (Number.isFinite(n) && n > 30000 && n < 70000) return serialToDate(n);
        }
        const norm = s.replace(/\./g, "-").replace(/\//g, "-");
        const parts = norm.split("-");
        if (parts.length === 3) {
          const [a, b, c] = parts;
          if (a.length === 4) {
            const d = new Date(Number(a), Number(b) - 1, Number(c));
            if (!isNaN(d)) return d;
          } else if (c.length === 4) {
            const d = new Date(Number(c), Number(a) - 1, Number(b));
            if (!isNaN(d)) return d;
          }
        }
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }
      function serialToDate(n) {
        const epoch = Date.UTC(1899, 11, 30);
        return new Date(epoch + n * 86400 * 1000);
      }
      function escapeHtml(str) {
        return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
      }
      function escapeAttr(str) {
        return String(str || "")
          .replaceAll("&", "&amp;")
          .replaceAll('"', "&quot;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");
      }
      function toggleLoading(show) {
        $loading.classList.toggle("d-none", !show);
      }
      function showError(msg) {
        $error.textContent = msg;
        $error.classList.remove("d-none");
      }
      function clearError() {
        $error.textContent = "";
        $error.classList.add("d-none");
      }

      function handleResize() {
        applyMobileNameTransform();
        adjustWeekMinHeights();
      }
      function afterLayout(fn) {
        requestAnimationFrame(() => requestAnimationFrame(fn));
      }
      function debounce(fn, wait) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(null, args), wait);
        };
      }
    </script>
  </body>
</html>
