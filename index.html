<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>健管學員清單（Sheets API v4 → Bootstrap 5）</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      /* 頂部留白；左右 0 */
      body {
        margin: 0;
        padding: 12px 0 0 0;
        padding-top: max(12px, env(safe-area-inset-top));
      }

      .table-fixed-header thead th { position: sticky; top: 0; background: #fff; z-index: 1; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace; }

      /* ===== 進度地圖（蛇形路線） ===== */
      .board-wrap { width: 100%; padding-top: 48px; /* 預留棋子浮出空間 */ }
      .board-grid { display: flex; flex-direction: column; gap: 10px; width: 100%; }
      /* 一行最多 7 格，等分全寬 */
      .board-row  { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 8px; width: 100%; }
      .board-cell {
        position: relative;
        aspect-ratio: 1 / 1;
        border-radius: 12px;
        border: 1px solid #dee2e6;
        background: url('background.jpg') center/cover no-repeat;
        overflow: visible;               /* 允許棋子超出格子 */
        transition: transform .2s ease;
      }
      .day-label {
        position: absolute; top: 4px; left: 6px;
        font-weight: 800; font-size: .85rem; color: #111;
        text-shadow: 0 1px 0 rgba(255,255,255,.7);
      }
      /* 棋子群：固定在格子上方中央，可超出格子 */
      .pawns-bar {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 6px;
        padding-bottom: 8px;
        z-index: 10;
      }
      .pawn-img {
        width: 32px; height: 32px;
        border-radius: 50%;
        background: url('people.jpg') center/cover no-repeat;
        border: 2px solid #fff; box-shadow: 0 0 0 .12rem rgba(0,0,0,.08);
      }
      /* 底部姓名列（獨立於棋子） */
      .names-bar {
        position: absolute; left: 4px; right: 4px; bottom: 4px;
        display: flex; flex-wrap: wrap; justify-content: center; gap: 4px;
        pointer-events: none;
      }
      .name-chip {
        pointer-events: auto;
        font-size: .75rem; font-weight: 700; line-height: 1.1;
        max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        background: rgba(255,255,255,.9);
        border: 1px solid rgba(0,0,0,.06);
        border-radius: 6px; padding: 2px 6px;
      }
      /* 同一天多人 → 桌面下逐級縮小 */
      .board-cell.multi .name-chip { font-size: .72rem; max-width: 92px; }
      .board-cell.multi-3 .name-chip { font-size: .68rem; max-width: 86px; }
      .board-cell.multi-4plus .name-chip { font-size: .64rem; max-width: 80px; }
      .board-cell.multi .pawn-img { width: 28px; height: 28px; }
      .board-cell.multi-3 .pawn-img { width: 26px; height: 26px; }
      .board-cell.multi-4plus .pawn-img { width: 24px; height: 24px; }

      /* ===== 手機模式特化（重點在這裡） ===== */
      @media (max-width: 575.98px) {
        /* 名字縮到最小、寬度更窄；頭像也縮小 */
        .name-chip { font-size: .60rem; max-width: 60px; padding: 1px 4px; }
        .board-cell.multi .name-chip { font-size: .56rem; max-width: 54px; }
        .board-cell.multi-3 .name-chip { font-size: .52rem; max-width: 48px; }
        .board-cell.multi-4plus .name-chip { font-size: .50rem; max-width: 44px; }
        .pawn-img { width: 24px; height: 24px; }
        .board-cell.multi .pawn-img { width: 22px; height: 22px; }
        .board-cell.multi-3 .pawn-img { width: 20px; height: 20px; }
        .board-cell.multi-4plus .pawn-img { width: 18px; height: 18px; }
        /* 沒有名字（沒任何學員）→ 視覺縮小 2/3 寬 */
        .board-cell.empty-cell { transform: scaleX(0.66); transform-origin: center; }
      }

      /* ===== 狀態 / 菜單 / 週數（延續既有樣式） ===== */
      .badge-status { font-weight: 700; font-size: 0.95rem; padding: 0.5em 0.65em; line-height: 1; }
      .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; border: 1px solid var(--bs-border-color,#dee2e6); vertical-align: middle; }
      .badge-menu { font-weight: 600; font-size: 0.9rem; padding: 0.45em 0.6em; line-height: 1; }
      .table-center thead th, .table-center tbody td { text-align: center; vertical-align: middle; }

      .week-grid { display: inline-flex; gap: 0.3rem; justify-content: center; align-items: center; }
      .week-box { width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: .5rem; font-weight: 800; font-size: .9rem; user-select: none; border: 1px solid var(--bs-border-color,#dee2e6); }
      .week-box.inactive { background: var(--bs-light); color: var(--bs-secondary); }
      .week-box.c1 { background:#ef4444;color:#fff;border-color:#ef4444;box-shadow:0 0 0 .12rem rgba(239,68,68,.15);}/*紅*/
      .week-box.c2 { background:#f59e0b;color:#111;border-color:#f59e0b;box-shadow:0 0 0 .12rem rgba(245,158,11,.15);}/*橙*/
      .week-box.c3 { background:#facc15;color:#111;border-color:#facc15;box-shadow:0 0 0 .12rem rgba(250,204,21,.20);}/*黃*/
      .week-box.c4 { background:#22c55e;color:#fff;border-color:#22c55e;box-shadow:0 0 0 .12rem rgba(34,197,94,.18);}/*綠*/
      .week-box.c5 { background:#3b82f6;color:#fff;border-color:#3b82f6;box-shadow:0 0 0 .12rem rgba(59,130,246,.18);}/*藍*/
      .week-box.c6 { background:#6366f1;color:#fff;border-color:#6366f1;box-shadow:0 0 0 .12rem rgba(99,102,241,.18);}/*靛*/
      .week-box.c7 { background:#a855f7;color:#fff;border-color:#a855f7;box-shadow:0 0 0 .12rem rgba(168,85,247,.18);}/*紫*/
    </style>
  </head>
  <body>
    <div class="container-fluid px-0">
      <!-- ===== 進度地圖 ===== -->
      <div class="board-wrap px-3 mb-3">
        <h2 class="h5 mb-2">進度地圖</h2>
        <div id="boardGrid" class="board-grid" aria-label="健管 45 天蛇形路線"></div>
      </div>

      <h1 class="h3 mb-3 px-3">高雄博士班-健管45學員清單</h1>

      <!-- 篩選 + 重新讀取 -->
      <div class="row g-2 align-items-center mb-3 px-3">
        <div class="col-auto"><label for="filterInput" class="col-form-label">關鍵字篩選：</label></div>
        <div class="col-12 col-sm-6 col-md-4"><input type="text" id="filterInput" class="form-control" placeholder="輸入姓名 / 教練 / 狀態 / 菜單 …" /></div>
        <div class="col-auto"><button id="reloadBtn" class="btn btn-outline-primary">重新讀取</button></div>
      </div>

      <!-- 載入中 / 錯誤 -->
      <div id="loading" class="alert alert-secondary mx-3" role="alert">正在從 Google 試算表載入資料…</div>
      <div id="error" class="alert alert-danger d-none mx-3" role="alert"></div>

      <!-- 表格 -->
      <div class="table-responsive px-3">
        <table id="dataTable" class="table table-striped table-hover align-middle table-fixed-header table-center mb-0">
          <thead class="table-light"><tr id="theadRow"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      // ==== 設定 ====
      const API_KEY    = "AIzaSyD14dE-5ouFvIxnTrwF3zhHqFhh9OW0q8c";
      const SHEET_ID   = "1vFrSu2c0UWTeyKdDcNwuwVUOSKHdRuTZ3PwzcoLyLEo";
      const SHEET_NAME = "健管學員清單";

      const SOURCE_HEADERS  = ["狀態","第幾天","學員姓名","專屬教練","開始日期","結束日期","今日菜單"];
      const DISPLAY_HEADERS = ["狀態","學員姓名","天數","週數","專屬教練","執行日期","今日菜單"];
      const MOBILE_KEEP     = new Set(["狀態","學員姓名","天數","週數","專屬教練","今日菜單"]);
      const MAX_DAYS = 45;

      // 手機媒體查詢（Bootstrap sm 斷點）
      const MOBILE_MQ = window.matchMedia("(max-width: 575.98px)");

      // ==== DOM ====
      const $loading = document.getElementById("loading");
      const $error   = document.getElementById("error");
      const $thead   = document.getElementById("theadRow");
      const $tbody   = document.getElementById("tbody");
      const $filter  = document.getElementById("filterInput");
      const $reload  = document.getElementById("reloadBtn");
      const $board   = document.getElementById("boardGrid");

      let _rawRows = []; // 關鍵字篩選基底

      // 初次載入
      buildMonopolyBoard();
      fetchAndRender();

      // 事件
      $reload.addEventListener("click", fetchAndRender);
      $filter.addEventListener("input", applyFilter);
      MOBILE_MQ.addEventListener("change", () => {
        // 斷點切換時，重新套用姓名顯示（全名 ↔ 倒數兩字）
        updateNameChipsForViewport();
      });

      function colClass(headerDisplay) {
        return MOBILE_KEEP.has(headerDisplay) ? "" : "d-none d-sm-table-cell";
      }

      // === 生成蛇形 45 天地圖（1→7 週；奇數週 L→R，偶數週 R→L） ===
      function buildMonopolyBoard() {
        $board.innerHTML = "";
        for (let w = 1; w <= 7; w++) {
          const row = document.createElement("div");
          row.className = "board-row";
          for (let c = 1; c <= 7; c++) {
            const dayAbs = (w - 1) * 7 + (w % 2 === 1 ? c : (8 - c)); // 蛇形編號
            if (dayAbs > MAX_DAYS) continue;
            const cell = document.createElement("div");
            cell.className = "board-cell";
            cell.id = `cell-day-${dayAbs}`;
            cell.setAttribute("data-day", String(dayAbs));
            cell.innerHTML = `
              <div class="day-label">${dayAbs}</div>
              <div class="pawns-bar"></div>
              <div class="names-bar"></div>
            `;
            row.appendChild(cell);
          }
          $board.appendChild(row);
        }
      }

      async function fetchAndRender() {
        toggleLoading(true);
        clearError();
        $tbody.innerHTML = "";
        $thead.innerHTML = DISPLAY_HEADERS.map(h => `<th scope="col" class="${colClass(h)}">${h}</th>`).join("");

        try {
          const rangeA1 = `${SHEET_NAME}!A:Z`;
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(rangeA1)}?key=${API_KEY}`;
          const resp = await fetch(url, { method: "GET" });
          if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
          const data = await resp.json();

          const values = data.values || [];
          if (values.length === 0) {
            showError("工作表沒有資料。");
            toggleLoading(false);
            return;
          }

          const headerRow = values[0].map(v => (v ?? "").trim());
          const bodyRows  = values.slice(1);

          const colIndexByLabel = {};
          headerRow.forEach((label, idx) => { if (label) colIndexByLabel[label] = idx; });

          const missing = SOURCE_HEADERS.filter(h => !(h in colIndexByLabel));
          if (missing.length) showError(`下列表頭在工作表中找不到：${missing.join("、")}。請確認表頭文字一致。`);

          const nameIdx  = colIndexByLabel["學員姓名"];
          const dayIdx   = colIndexByLabel["第幾天"];
          const startIdx = colIndexByLabel["開始日期"];
          const endIdx   = colIndexByLabel["結束日期"];

          const records = [];
          for (const row of bodyRows) {
            if (!row || row.every(cell => String(cell || "").trim() === "")) continue;
            // 姓名空白略過
            const nameVal = Number.isInteger(nameIdx) ? String(row[nameIdx] ?? "").trim() : "";
            if (!nameVal) continue;

            const statusTxt   = getCell(row, colIndexByLabel["狀態"]);
            const isCompleted = /已完成/i.test(statusTxt);
            const isInProgress= /進行中/i.test(statusTxt);

            const startRaw = getCell(row, startIdx);
            const startDate = parseSheetDate(startRaw);

            records.push({ row, statusTxt, isCompleted, isInProgress, startDate });
          }

          // 排序：已完成放最後；其餘依開始日期由早到晚
          records.sort((a, b) => {
            if (a.isCompleted !== b.isCompleted) return a.isCompleted ? 1 : -1;
            const ta = a.startDate ? a.startDate.getTime() : Number.POSITIVE_INFINITY;
            const tb = b.startDate ? b.startDate.getTime() : Number.POSITIVE_INFINITY;
            return ta - tb;
          });

          // 表格渲染
          const rowsHtml = [];
          _rawRows = [];
          for (const rec of records) {
            const { row, statusTxt, isCompleted } = rec;
            const tds = [];
            const rowTextCollector = [];

            for (const headerDisplay of DISPLAY_HEADERS) {
              if (headerDisplay === "週數") {
                let weekNum = 0;
                const n = Number(getCell(row, dayIdx));
                if (Number.isFinite(n) && n > 0 && n <= MAX_DAYS) weekNum = Math.ceil(n / 7);
                const weekNumToRender = isCompleted ? 7 : weekNum;
                tds.push(`<td class="${colClass(headerDisplay)}">${renderWeekGridResponsive(weekNumToRender)}</td>`);
                rowTextCollector.push(String(weekNumToRender || ""));
                continue;
              }

              if (headerDisplay === "執行日期") {
                const startTxtRaw = getCell(row, startIdx);
                const endTxtRaw   = getCell(row, endIdx);
                const startDisp   = formatDateDisplay(startTxtRaw);
                const endDisp     = formatDateDisplay(endTxtRaw);
                const cellHtml = (startDisp || endDisp)
                  ? `<div class="d-flex flex-column align-items-center">
                       <span class="fw-semibold">${escapeHtml(startDisp)}</span>
                       <span class="text-secondary small">${escapeHtml(endDisp)}</span>
                     </div>` : "";
                tds.push(`<td class="${colClass(headerDisplay)}">${cellHtml}</td>`);
                rowTextCollector.push(`${startDisp} ${endDisp}`);
                continue;
              }

              // 對應來源表頭
              let sourceHeader = headerDisplay;
              if (headerDisplay === "天數") sourceHeader = "第幾天";
              const idx = colIndexByLabel[sourceHeader];
              const txt = getCell(row, idx);

              if (sourceHeader === "狀態") {
                const s = (statusTxt || txt || "").trim();
                let badgeCls = "bg-secondary text-white";
                let dotBg    = "bg-secondary";
                if (/已完成/i.test(s)) { badgeCls = "bg-primary text-white"; dotBg = "bg-primary"; }
                else if (/未開始/i.test(s)) { badgeCls = "bg-light text-dark border"; dotBg = "bg-light"; }
                else if (/進行中/i.test(s)) { badgeCls = "bg-success text-white"; dotBg = "bg-success"; }
                const desktop = `<span class="badge ${badgeCls} badge-status d-none d-sm-inline-block">${escapeHtml(s)}</span>`;
                const mobile  = `<span class="status-dot ${dotBg} d-inline-block d-sm-none" title="${escapeHtml(s)}" aria-label="${escapeHtml(s)}"></span>`;
                tds.push(`<td class="${colClass(headerDisplay)}">${desktop}${mobile}</td>`);
              } else if (sourceHeader === "今日菜單" && txt) {
                const s = txt.replace(/\s/g, "");
                let cls = "";
                if (/^(準備日|準)$/i.test(s)) cls = "bg-danger text-white";
                else if (/^(纖體日|纖)$/i.test(s)) cls = "bg-success text-white";
                else if (/^(蛋白日|蛋)$/i.test(s)) cls = "bg-secondary text-white";
                else if (/^(新陳代謝日|代)$/i.test(s)) cls = "bg-primary text-white";
                if (cls) tds.push(`<td class="${colClass(headerDisplay)}"><span class="badge ${cls} badge-menu">${escapeHtml(txt)}</span></td>`);
                else tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
              } else {
                tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
              }

              rowTextCollector.push(txt);
            }

            _rawRows.push(rowTextCollector.join(" ").toLowerCase());
            rowsHtml.push(`<tr>${tds.join("")}</tr>`);
          }
          $tbody.innerHTML = rowsHtml.join("");
          applyFilter();

          // 地圖：進行中學員 → 棋子浮上方、姓名在底部
          renderBoardPawns(records, colIndexByLabel);
          // 手機下套用倒數兩字顯示
          updateNameChipsForViewport();
          // 更新空格子縮窄
          updateEmptyCellClass();
        } catch (err) {
          showError("讀取失敗：" + (err?.message || err));
        } finally {
          toggleLoading(false);
        }
      }

      // 把進行中學員放到對應格子（棋子浮出、姓名在底部）
      function renderBoardPawns(records, colIndexByLabel) {
        // 清空
        document.querySelectorAll(".board-cell .pawns-bar, .board-cell .names-bar").forEach(bar => bar.innerHTML = "");
        document.querySelectorAll(".board-cell").forEach(cell => {
          cell.classList.remove("multi","multi-3","multi-4plus","empty-cell");
        });

        const nameIdx = colIndexByLabel["學員姓名"];
        const dayIdx  = colIndexByLabel["第幾天"];

        for (const rec of records) {
          if (!rec.isInProgress) continue; // 只放進行中
          const name = getCell(rec.row, nameIdx);
          const n    = Number(getCell(rec.row, dayIdx));
          if (!Number.isFinite(n) || n <= 0 || n > MAX_DAYS) continue;

          const cell = document.getElementById(`cell-day-${n}`);
          if (!cell) continue;

          const pawnsBar = cell.querySelector(".pawns-bar");
          const namesBar = cell.querySelector(".names-bar");

          // 棋子（只放圖像）
          const pawnImg = document.createElement("div");
          pawnImg.className = "pawn-img";
          pawnImg.setAttribute("title", name);
          pawnImg.setAttribute("aria-label", name);
          pawnsBar.appendChild(pawnImg);

          // 姓名（底部 chip）
          const chip = document.createElement("div");
          chip.className = "name-chip";
          chip.dataset.fullname = name;              // 保留全名
          chip.textContent = name;                   // 先放全名，稍後依裝置改成倒數兩字
          namesBar.appendChild(chip);

          // 數量 → 縮放
          adjustCellMultiClass(cell);
        }
      }

      function adjustCellMultiClass(cell) {
        const count = cell.querySelectorAll(".pawns-bar .pawn-img").length;
        cell.classList.remove("multi","multi-3","multi-4plus");
        if (count >= 2) cell.classList.add("multi");
        if (count >= 3) cell.classList.add("multi-3");
        if (count >= 4) cell.classList.add("multi-4plus");
      }

      // 手機：姓名只顯示倒數兩個字；桌面：顯示全名
      function updateNameChipsForViewport() {
        const chips = document.querySelectorAll(".name-chip");
        chips.forEach(chip => {
          const full = chip.dataset.fullname || chip.textContent || "";
          chip.textContent = MOBILE_MQ.matches ? lastNChars(full, 2) : full;
        });
      }

      // 沒有名字的格子 → 標記 empty-cell（手機下會 scaleX(0.66)）
      function updateEmptyCellClass() {
        document.querySelectorAll(".board-cell").forEach(cell => {
          const hasName = cell.querySelector(".names-bar .name-chip");
          cell.classList.toggle("empty-cell", !hasName);
        });
      }

      function applyFilter() {
        const q = ($filter.value || "").trim().toLowerCase();
        const trs = $tbody.querySelectorAll("tr");
        if (!q) { trs.forEach(tr => tr.classList.remove("d-none")); return; }
        trs.forEach((tr, i) => {
          const hit = _rawRows[i]?.includes(q);
          tr.classList.toggle("d-none", !hit);
        });
      }

      // === 小工具 ===
      function lastNChars(str, n) {
        const arr = Array.from(String(str)); // 正確處理 surrogate pairs
        if (arr.length <= n) return arr.join("");
        return arr.slice(-n).join("");
      }

      function getCell(row, idx) { return (Number.isInteger(idx) && row[idx] != null) ? String(row[idx]).trim() : ""; }

      // 週數渲染（彩虹進度）
      function renderWeekGridResponsive(weekNum) {
        let grid = '<div class="week-grid d-none d-sm-inline-flex" aria-label="週數進度">';
        for (let i = 1; i <= 7; i++) {
          const cls = (weekNum >= i && i <= 7) ? `c${i}` : 'inactive';
          grid += `<span class="week-box ${cls}" title="第 ${i} 週">${i}</span>`;
        }
        grid += '</div>';
        let mobile;
        if (weekNum >= 1 && weekNum <= 7) {
          mobile = `<span class="week-box c${weekNum} d-inline-flex d-sm-none" title="第 ${weekNum} 週">${weekNum}</span>`;
        } else {
          mobile = `<span class="week-box inactive d-inline-flex d-sm-none" title="週數無效">–</span>`;
        }
        return grid + mobile;
      }

      // 友善日期顯示
      function formatDateDisplay(val) {
        const d = parseSheetDate(val);
        if (!d) return String(val || "").trim();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${y}/${m}/${dd}`;
      }

      // 解析日期 / Sheets 序列
      function parseSheetDate(val) {
        if (val == null) return null;
        const s = String(val).trim();
        if (!s) return null;
        if (/^\d+(\.\d+)?$/.test(s)) {
          const n = Number(s);
          if (Number.isFinite(n) && n > 30000 && n < 70000) return serialToDate(n);
        }
        const norm = s.replace(/\./g, "-").replace(/\//g, "-");
        const parts = norm.split("-");
        if (parts.length === 3) {
          const [a, b, c] = parts;
          if (a.length === 4) { const d = new Date(Number(a), Number(b)-1, Number(c)); if (!isNaN(d)) return d; }
          else if (c.length === 4) { const d = new Date(Number(c), Number(a)-1, Number(b)); if (!isNaN(d)) return d; }
        }
        const d = new Date(s);
        return isNaN(d) ? null : d;
      }
      function serialToDate(n) { const epoch = Date.UTC(1899,11,30); return new Date(epoch + n*86400*1000); }
      function escapeHtml(str) { return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;"); }
      function toggleLoading(show) { $loading.classList.toggle("d-none", !show); }
      function showError(msg) { $error.textContent = msg; $error.classList.remove("d-none"); }
      function clearError() { $error.textContent = ""; $error.classList.add("d-none"); }
    </script>
  </body>
</html>
