<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>健管學員清單（Sheets API v4 → Bootstrap 5）</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        padding: 24px;
      }
      .table-fixed-header thead th {
        position: sticky;
        top: 0;
        background: #fff;
        z-index: 1;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Liberation Mono", monospace;
      }

      /* 狀態徽章（桌面版文字） */
      .badge-status {
        font-weight: 700;
        font-size: 0.95rem;
        padding: 0.5em 0.65em;
        line-height: 1;
      }
      /* 手機版狀態小圓點 */
      .status-dot {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid var(--bs-border-color, #dee2e6);
        vertical-align: middle;
      }

      /* 今日菜單徽章 */
      .badge-menu {
        font-weight: 600;
        font-size: 0.9rem;
        padding: 0.45em 0.6em;
        line-height: 1;
      }

      /* 表格整體置中（含表頭與內容） */
      .table-center thead th,
      .table-center tbody td {
        text-align: center;
        vertical-align: middle;
      }

      /* 週數：7 個小方格（>=sm 顯示完整 1~7；<sm 只顯示單一當週格） */
      .week-grid {
        display: inline-flex;
        gap: 0.3rem;
        justify-content: center;
        align-items: center;
      }
      .week-box {
        width: 28px;
        height: 28px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-weight: 800;
        font-size: 0.9rem;
        user-select: none;
        border: 1px solid var(--bs-border-color, #dee2e6);
      }
      .week-box.inactive {
        background: var(--bs-light);
        color: var(--bs-secondary);
      }
      /* 彩虹顏色：紅橙黃綠藍靛紫（1→7） */
      .week-box.c1 {
        background: #ef4444;
        color: #fff;
        border-color: #ef4444;
        box-shadow: 0 0 0 0.12rem rgba(239, 68, 68, 0.15);
      } /* 紅 */
      .week-box.c2 {
        background: #f59e0b;
        color: #111;
        border-color: #f59e0b;
        box-shadow: 0 0 0 0.12rem rgba(245, 158, 11, 0.15);
      } /* 橙 */
      .week-box.c3 {
        background: #facc15;
        color: #111;
        border-color: #facc15;
        box-shadow: 0 0 0 0.12rem rgba(250, 204, 21, 0.2);
      } /* 黃 */
      .week-box.c4 {
        background: #22c55e;
        color: #fff;
        border-color: #22c55e;
        box-shadow: 0 0 0 0.12rem rgba(34, 197, 94, 0.18);
      } /* 綠 */
      .week-box.c5 {
        background: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.12rem rgba(59, 130, 246, 0.18);
      } /* 藍 */
      .week-box.c6 {
        background: #6366f1;
        color: #fff;
        border-color: #6366f1;
        box-shadow: 0 0 0 0.12rem rgba(99, 102, 241, 0.18);
      } /* 靛 */
      .week-box.c7 {
        background: #a855f7;
        color: #fff;
        border-color: #a855f7;
        box-shadow: 0 0 0 0.12rem rgba(168, 85, 247, 0.18);
      } /* 紫 */
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="h3 mb-3">健管學員清單</h1>

      <div class="alert alert-info">使用 <span class="mono">Google Sheets API v4</span> + API Key 讀取分頁 <strong>「健管學員清單」</strong>。若讀不到資料，請確認試算表共享權限與 API Key 限制。</div>

      <!-- 篩選 + 重新讀取 -->
      <div class="row g-2 align-items-center mb-3">
        <div class="col-auto">
          <label for="filterInput" class="col-form-label">關鍵字篩選：</label>
        </div>
        <div class="col-12 col-sm-6 col-md-4">
          <input type="text" id="filterInput" class="form-control" placeholder="輸入姓名 / 教練 / 狀態 / 菜單 …" />
        </div>
        <div class="col-auto">
          <button id="reloadBtn" class="btn btn-outline-primary">重新讀取</button>
        </div>
      </div>

      <!-- 載入中 / 錯誤 -->
      <div id="loading" class="alert alert-secondary" role="alert">正在從 Google 試算表載入資料…</div>
      <div id="error" class="alert alert-danger d-none" role="alert"></div>

      <!-- 表格 -->
      <div class="table-responsive">
        <table id="dataTable" class="table table-striped table-hover align-middle table-fixed-header table-center">
          <thead class="table-light">
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      // ==== 設定 ====
      const API_KEY = "AIzaSyD14dE-5ouFvIxnTrwF3zhHqFhh9OW0q8c"; // 你的 API Key
      const SHEET_ID = "1vFrSu2c0UWTeyKdDcNwuwVUOSKHdRuTZ3PwzcoLyLEo";
      const SHEET_NAME = "健管學員清單";

      // 來源表頭（讀取用；表內仍是「第幾天」）
      const SOURCE_HEADERS = ["狀態", "第幾天", "學員姓名", "專屬教練", "開始日期", "結束日期", "今日菜單"];

      // 顯示表頭（前端呈現名稱，順序固定）
      const DISPLAY_HEADERS = ["狀態", "學員姓名", "天數", "週數", "專屬教練", "開始日期", "結束日期", "今日菜單"];

      // 手機（<576px）保留欄位（其餘在手機自動隱藏）→ 加入「狀態」
      const MOBILE_KEEP = new Set(["狀態", "學員姓名", "天數", "週數", "專屬教練", "今日菜單"]);

      const MAX_DAYS = 45; // 45 天計畫

      // ==== DOM ====
      const $loading = document.getElementById("loading");
      const $error = document.getElementById("error");
      const $thead = document.getElementById("theadRow");
      const $tbody = document.getElementById("tbody");
      const $filter = document.getElementById("filterInput");
      const $reload = document.getElementById("reloadBtn");

      let _rawRows = []; // 用於關鍵字篩選

      // 初次載入
      fetchAndRender();

      // 綁定事件
      $reload.addEventListener("click", fetchAndRender);
      $filter.addEventListener("input", applyFilter);

      function colClass(headerDisplay) {
        return MOBILE_KEEP.has(headerDisplay) ? "" : "d-none d-sm-table-cell";
      }

      async function fetchAndRender() {
        toggleLoading(true);
        clearError();
        $tbody.innerHTML = "";
        $thead.innerHTML = DISPLAY_HEADERS.map((h) => `<th scope="col" class="${colClass(h)}">${h}</th>`).join("");

        try {
          const rangeA1 = `${SHEET_NAME}!A:Z`;
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${encodeURIComponent(rangeA1)}?key=${API_KEY}`;
          const resp = await fetch(url, { method: "GET" });
          if (!resp.ok) throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
          const data = await resp.json();

          const values = data.values || [];
          if (values.length === 0) {
            showError("工作表沒有資料。");
            toggleLoading(false);
            return;
          }

          const headerRow = values[0].map((v) => (v ?? "").trim());
          const bodyRows = values.slice(1);

          // 來源表頭→索引
          const colIndexByLabel = {};
          headerRow.forEach((label, idx) => {
            if (label) colIndexByLabel[label] = idx;
          });

          // 檢查缺少欄位
          const missing = SOURCE_HEADERS.filter((h) => !(h in colIndexByLabel));
          if (missing.length) showError(`下列表頭在工作表中找不到：${missing.join("、")}。請確認表頭文字一致。`);

          const nameIdx = colIndexByLabel["學員姓名"];
          const dayIdx = colIndexByLabel["第幾天"];
          const startIdx = colIndexByLabel["開始日期"];

          // 整理可排序記錄
          const records = [];
          for (const row of bodyRows) {
            if (!row || row.every((cell) => String(cell || "").trim() === "")) continue;
            // 姓名空白略過
            if (Number.isInteger(nameIdx)) {
              const nameVal = String(row[nameIdx] ?? "").trim();
              if (!nameVal) continue;
            }

            const statusTxt = getCell(row, colIndexByLabel["狀態"]);
            const isCompleted = /已完成/i.test(statusTxt);

            const startRaw = getCell(row, startIdx);
            const startDate = parseSheetDate(startRaw);

            records.push({ row, isCompleted, statusTxt, startDate });
          }

          // 排序：已完成放最後；其餘依開始日期由早到晚
          records.sort((a, b) => {
            if (a.isCompleted !== b.isCompleted) return a.isCompleted ? 1 : -1;
            const ta = a.startDate ? a.startDate.getTime() : Number.POSITIVE_INFINITY;
            const tb = b.startDate ? b.startDate.getTime() : Number.POSITIVE_INFINITY;
            return ta - tb;
          });

          // 產生表格
          const rowsHtml = [];
          _rawRows = [];
          for (const { row, isCompleted, statusTxt } of records) {
            const tds = [];
            const rowTextCollector = [];

            for (const headerDisplay of DISPLAY_HEADERS) {
              if (headerDisplay === "週數") {
                // 由「第幾天」計算週次；「已完成」顯示滿格（7）
                let weekNum = 0;
                if (Number.isInteger(dayIdx)) {
                  const raw = getCell(row, dayIdx);
                  const n = Number(raw);
                  if (Number.isFinite(n) && n > 0 && n <= MAX_DAYS) weekNum = Math.ceil(n / 7); // 1..7
                }
                const weekNumToRender = isCompleted ? 7 : weekNum;
                tds.push(`<td class="${colClass(headerDisplay)}">${renderWeekGridResponsive(weekNumToRender)}</td>`);
                rowTextCollector.push(String(weekNumToRender || ""));
                continue;
              }

              // 顯示表頭對應來源表頭
              let sourceHeader = headerDisplay;
              if (headerDisplay === "天數") sourceHeader = "第幾天";

              const idx = colIndexByLabel[sourceHeader];
              const txt = getCell(row, idx);

              if (sourceHeader === "狀態") {
                // 狀態：桌面版顯示文字徽章；手機版顯示彩色圓點
                const s = (statusTxt || txt || "").trim();
                let badgeCls = "bg-secondary text-white";
                let dotBg = "bg-secondary";
                if (/已完成/i.test(s)) {
                  badgeCls = "bg-primary text-white";
                  dotBg = "bg-primary";
                } else if (/未開始/i.test(s)) {
                  badgeCls = "bg-light text-dark border";
                  dotBg = "bg-light";
                } else if (/進行中/i.test(s)) {
                  badgeCls = "bg-success text-white";
                  dotBg = "bg-success";
                }

                const desktop = `<span class="badge ${badgeCls} badge-status d-none d-sm-inline-block">${escapeHtml(s)}</span>`;
                const mobile = `<span class="status-dot ${dotBg} d-inline-block d-sm-none" title="${escapeHtml(s)}" aria-label="${escapeHtml(s)}"></span>`;
                tds.push(`<td class="${colClass(headerDisplay)}">${desktop}${mobile}</td>`);
              } else if (sourceHeader === "今日菜單" && txt) {
                // 今日菜單徽章
                const s = txt.replace(/\s/g, "");
                let cls = "";
                if (/^(準備日|準)$/i.test(s)) cls = "bg-danger text-white";
                else if (/^(纖體日|纖)$/i.test(s)) cls = "bg-success text-white";
                else if (/^(蛋白日|蛋)$/i.test(s)) cls = "bg-secondary text-white";
                else if (/^(新陳代謝日|代)$/i.test(s)) cls = "bg-primary text-white";
                if (cls) tds.push(`<td class="${colClass(headerDisplay)}"><span class="badge ${cls} badge-menu">${escapeHtml(txt)}</span></td>`);
                else tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
              } else {
                tds.push(`<td class="${colClass(headerDisplay)}">${escapeHtml(txt)}</td>`);
              }

              rowTextCollector.push(txt);
            }

            _rawRows.push(rowTextCollector.join(" ").toLowerCase());
            rowsHtml.push(`<tr>${tds.join("")}</tr>`);
          }

          $tbody.innerHTML = rowsHtml.join("");
          applyFilter();
        } catch (err) {
          showError("讀取失敗：" + (err?.message || err));
        } finally {
          toggleLoading(false);
        }
      }

      function applyFilter() {
        const q = ($filter.value || "").trim().toLowerCase();
        const trs = $tbody.querySelectorAll("tr");
        if (!q) {
          trs.forEach((tr) => tr.classList.remove("d-none"));
          return;
        }
        trs.forEach((tr, i) => {
          const hit = _rawRows[i]?.includes(q);
          tr.classList.toggle("d-none", !hit);
        });
      }

      // === 小工具 ===
      function getCell(row, idx) {
        return Number.isInteger(idx) && row[idx] != null ? String(row[idx]).trim() : "";
      }

      // 週數渲染（彩虹進度）：
      // >= sm：顯示 1~7，i <= weekNum → c{i} 彩色；i > weekNum → 灰色
      // <  sm：僅顯示當週單一格（c{weekNum}）；無效週 → 灰色「–」
      function renderWeekGridResponsive(weekNum) {
        // 桌面版：1~7 進度上色
        let grid = '<div class="week-grid d-none d-sm-inline-flex" aria-label="週數進度">';
        for (let i = 1; i <= 7; i++) {
          const cls = weekNum >= i && i <= 7 ? `c${i}` : "inactive";
          grid += `<span class="week-box ${cls}" title="第 ${i} 週">${i}</span>`;
        }
        grid += "</div>";

        // 手機：單一當週格
        let mobile;
        if (weekNum >= 1 && weekNum <= 7) {
          mobile = `<span class="week-box c${weekNum} d-inline-flex d-sm-none" title="第 ${weekNum} 週">${weekNum}</span>`;
        } else {
          mobile = `<span class="week-box inactive d-inline-flex d-sm-none" title="週數無效">–</span>`;
        }
        return grid + mobile;
      }

      // 解析可能的日期格式 / 序列
      function parseSheetDate(val) {
        if (val == null) return null;
        const s = String(val).trim();
        if (!s) return null;

        // Sheets 日期序列（約 1900-01-01 之後）
        if (/^\d+(\.\d+)?$/.test(s)) {
          const n = Number(s);
          if (Number.isFinite(n) && n > 30000 && n < 70000) return serialToDate(n);
        }

        // 常見格式
        const norm = s.replace(/\./g, "-").replace(/\//g, "-");
        const parts = norm.split("-");
        if (parts.length === 3) {
          const [a, b, c] = parts;
          if (a.length === 4) {
            // YYYY-M-D
            const d = new Date(Number(a), Number(b) - 1, Number(c));
            if (!isNaN(d)) return d;
          } else if (c.length === 4) {
            // M-D-YYYY
            const d = new Date(Number(c), Number(a) - 1, Number(b));
            if (!isNaN(d)) return d;
          }
        }

        const d = new Date(s);
        return isNaN(d) ? null : d;
      }

      function serialToDate(n) {
        const epoch = Date.UTC(1899, 11, 30); // 1899-12-30
        const ms = n * 86400 * 1000;
        return new Date(epoch + ms);
      }

      function escapeHtml(str) {
        return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
      }
      function toggleLoading(show) {
        $loading.classList.toggle("d-none", !show);
      }
      function showError(msg) {
        $error.textContent = msg;
        $error.classList.remove("d-none");
      }
      function clearError() {
        $error.textContent = "";
        $error.classList.add("d-none");
      }
    </script>
  </body>
</html>
